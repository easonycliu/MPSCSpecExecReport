# Bind programmer threads to application threads and bind to specified cores
## Setting
* Memory limit: 32G
* Osprey param: window size 32768, batch size 131072
* mem limit low = 24G, mem limit high = 28G, mem limit max = 32G
* Vector size: 512
* Thread num: 4

## Results

| Workload  | Osprey  |   MAGE |     OS |   Unbounded |
|:----------|--------:|-------:|-------:|------------:|
| mvmul     |   56.6s |  43.3s | 188.3s |       13.1s |

* Improve: The gap between different threads became smaller
```
Worker 3 at thread tid 116154 finished calculation in 50371 milliseconds
Worker 2 at thread tid 116153 finished calculation in 55820 milliseconds
Worker 0 at thread tid 116151 finished calculation in 56297 milliseconds
Worker 1 at thread tid 116152 finished calculation in 56629 milliseconds
```

* Problem: The performance keeps bad

# Osprey on new machine is very sensitive to parameters `window_size` and `batch_size`
## Adjust setting
* Prev osprey param: window size 32768, batch size 131072
	* Best suitable when thread num is 1
	* Not suitable when thread num is 4
* New osprey param: window size 8192, batch size 32768
	* Best suitable when thread num is 4

## Results

| Workload  | Osprey  |   MAGE |     OS |   Unbounded |
|:----------|--------:|-------:|-------:|------------:|
| mvmul     |   32.0s |  43.3s | 188.3s |       13.1s |

```
Worker 3 at thread tid 132644 finished calculation in 30149 milliseconds
Worker 1 at thread tid 132642 finished calculation in 30978 milliseconds
Worker 2 at thread tid 132643 finished calculation in 31919 milliseconds
Worker 0 at thread tid 132641 finished calculation in 32006 milliseconds
```

* Problem: Time spent in `mprot_uffd` is still high
```
MPROT-UFFD (ns): ( min = 4898, avg = 10162113, max = 83120874, count = 1055, sum = 10721029978 )
```
* Suspection: `mprot_uffd` is blocked by `madvise`
* Try: Use a lock for `mprot_uffd` and `madvise` so no concurrent operations exists
```
MPROT-UFFD (ns): ( min = 3577, avg = 10144603, max = 26020825, count = 2110, sum = 21405112418 )
```

* Takeaway: performance is hitting the upperbound - strictly linear to the thread num (duration = 133s when thread num = 1)
	* Further improvments should gain from improving performance at single thread setting

# Design of evaluation
* Keep the same evaluations as in SOSP submission
* Run protocals ckks and EMP-Toolkits
* Update the setting according to the new machine

| Protocal     | Workload   |   Problem Size | Metric               |
|:-------------|:-----------|---------------:|:---------------------|
| CKKS         | Sum        |         262144 | Calculation Time (s) |
| CKKS         | Stat       |         262144 | Calculation Time (s) |
| CKKS         | Mvmul      |            512 | Calculation Time (s) |
| CKKS         | Matmul     |            192 | Calculation Time (s) |
| CKKS         | Tmatmul    |            192 | Calculation Time (s) |
| EMP-Toolkits | MSorted    |        4194304 | Total Time (s)       |
| EMP-Toolkits | Sort       |        4194304 | Total Time (s)       |
| EMP-Toolkits | Ljoin      |           4096 | Total Time (s)       |
| EMP-Toolkits | Mvmul      |           8192 | Total Time (s)       |
| EMP-Toolkits | Matmul     |          12288 | Total Time (s)       |

# TODO
* Adapt new EMP-Toolkits
* Run experiments
